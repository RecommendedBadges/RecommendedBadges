version: 2.1

# to use dynamic configuration
setup: true
orbs:
  continuation: circleci/continuation@0.1.2

jobs:
  setup:
    docker:
      - image: cimg/node:lts
    executor: continuation/default
    steps:
        - checkout
        - run:
            name: Install GH CLI
            command: |
              type -p curl >/dev/null || sudo apt install curl -y
              curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
              && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
              && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
              && sudo apt update \
              && sudo apt install gh -y
              echo $GH_ACCESS_TOKEN | gh auth login --with-token
        - run:
            name: Check Package Toggle
            command: |
              createPackages=$(node nodescripts/getPackageToggle.js)
              if [[ -n "$createPackages" ]]; then
                echo '{"create-packages": true}' > parameters.json
              else
                echo '{"create-packages": false}' > parameters.json
              fi
        - continuation/continue:
            configuration_path: .circleci/static-config.yml
            parameters: parameters.json

workflows:
  setup:
    jobs:
      - setup